<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Managing Measurement Archive Data &mdash; perfSONAR Toolkit 4.2.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/perfsonar.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="perfSONAR Toolkit 4.2.1 documentation" href="index.html" />
    <link rel="next" title="esmond API Reference" href="esmond_api_rest.html" />
    <link rel="prev" title="Clustering a Measurement Archive" href="multi_ma_clustering.html" /> 
  </head>
  <body>
    <header>
        <div class="headerContents">
          <a href="index.html" border="0"><img src="_static/perfSONAR-header.gif"></a>
          <div class="acctSearchContainer">
              <section id="searchBox" class="searchBox">
                  <!--Use of this code assumes agreement with the Google Custom Search Terms of Service. -->
                  <!--The terms of service are available at http://www.google.com/cse/docs/tos.html -->
                  <form action="search.html" id="cse-search-box" method="get">
                    <input type="text" name="q" size="25" class="searchInput" placeholder="Search"/>
                    <input type="hidden" name="check_keywords" value="yes" />
                    <input type="hidden" name="area" value="default" />
                  </form>
              </section>
         </div>
        </div>
    </header>
    <div style="display:block;clear:both;">
    
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="esmond_api_rest.html" title="esmond API Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="multi_ma_clustering.html" title="Clustering a Measurement Archive"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">perfSONAR Toolkit 4.2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="managing-measurement-archive-data">
<h1>Managing Measurement Archive Data<a class="headerlink" href="#managing-measurement-archive-data" title="Permalink to this headline">¶</a></h1>
<p>As you collect measurements over time, there are some common tasks you may wish to perform such as:</p>
<ul class="simple">
<li>Backing-up the data</li>
<li>Migrating the data to new hardware</li>
<li>Deleting old data</li>
</ul>
<p>The measurement archive software, esmond, keeps data in two databases: <a class="reference external" href="https://cassandra.apache.org">Cassandra</a> and <a class="reference external" href="http://www.postgresql.org">PostgreSQL</a>. Both of these databases need to be considered when performing any of the operations listed above. The remainder of this document covers the options and steps needed to perform each of these data management tasks.</p>
<div class="section" id="backing-up-and-restoring-data">
<h2>Backing-up and Restoring Data<a class="headerlink" href="#backing-up-and-restoring-data" title="Permalink to this headline">¶</a></h2>
<p>You may want to back-up data in case of a failure. Both Cassandra and PostgreSQL offer multiple options for backing-up and restoring data. A few common options are:</p>
<ul class="simple">
<li><strong>Using built-in replication features of each database</strong> - See <a class="reference internal" href="multi_ma_clustering.html"><em>Clustering a Measurement Archive</em></a> for more details</li>
<li><strong>Using existing tools to create snapshots</strong> - The remainder of this section discusses how to do this for both Cassandra and PostgreSQL</li>
</ul>
<div class="section" id="cassandra-snapshots-with-nodetool">
<span id="multi-ma-backups-snapshots-cassandra"></span><h3>Cassandra Snapshots with <cite>nodetool</cite><a class="headerlink" href="#cassandra-snapshots-with-nodetool" title="Permalink to this headline">¶</a></h3>
<div class="section" id="preparing-your-environment">
<span id="multi-ma-backups-snapshots-cassandra-prep"></span><h4>Preparing Your Environment<a class="headerlink" href="#preparing-your-environment" title="Permalink to this headline">¶</a></h4>
<p>Cassandra comes with a command called <em>nodetool</em> that is capable of performing a number of administrative operations. One such operation is creating and restoring snapshots of the data. In order to make sure your cassandra server can use nodetool, login to your cassandra host(s) and do the following:</p>
<ol class="arabic">
<li><p class="first">Uncomment or add the following at the bottom of <em>/etc/cassandra/conf/cassandra-env.sh</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>LOCAL_JMX=yes

if [ &quot;$LOCAL_JMX&quot; = &quot;yes&quot; ]; then
  JVM_OPTS=&quot;$JVM_OPTS -Dcassandra.jmx.local.port=$JMX_PORT -XX:+DisableExplicitGC&quot;
else
  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.port=$JMX_PORT&quot;
  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT&quot;
  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.ssl=false&quot;
  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=true&quot;
  JVM_OPTS=&quot;$JVM_OPTS -Dcom.sun.management.jmxremote.password.file=/etc/cassandra/jmxremote.password&quot;
fi
</pre></div>
</div>
</li>
<li><p class="first">Restart cassandra:</p>
<div class="highlight-python"><div class="highlight"><pre>service cassandra restart
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="creating-the-snapshot">
<h4>Creating the Snapshot<a class="headerlink" href="#creating-the-snapshot" title="Permalink to this headline">¶</a></h4>
<p>You can create a snapshot of the esmond data with the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>nodetool snapshot esmond -t esmond_snapshot
</pre></div>
</div>
<p>You may use a different value for -t, it is just a label for the snapshot. If -t is not specified a Unix timestamp of the current time will be used. Assuming you use esmond_snapshot as your value for -t the command will create the following directories:</p>
<ul class="simple">
<li>/var/lib/cassandra/data/esmond/base_rates/snapshots/esmond_snapshot</li>
<li>/var/lib/cassandra/data/esmond/rate_aggregations/snapshots/esmond_snapshot</li>
<li>/var/lib/cassandra/data/esmond/raw_data/snapshots/esmond_snapshot</li>
<li>/var/lib/cassandra/data/esmond/stat_aggregations/snapshots/esmond_snapshot</li>
</ul>
<p>Note that the directories above contain hard links to the original files, so they should not take a large amount of space on the existing disk. This also means you cannot delete the original files until these are removed.</p>
</div>
<div class="section" id="moving-snapshots-to-a-remote-server">
<h4>Moving Snapshots to a Remote Server<a class="headerlink" href="#moving-snapshots-to-a-remote-server" title="Permalink to this headline">¶</a></h4>
<p>You may optionally want to move your back-ups to a remote server. The steps to do so are as follows:</p>
<ol class="arabic">
<li><p class="first">Create a tarball of the snapshot files:</p>
<div class="highlight-python"><div class="highlight"><pre>tar -czf esmond-snapshot-base_rates.tgz /var/lib/cassandra/data/esmond/base_rates/snapshots/esmond_snapshot
tar -czf esmond-snapshot-rate_aggregations.tgz /var/lib/cassandra/data/esmond/rate_aggregations/snapshots/esmond_snapshot
tar -czf esmond-snapshot-raw_data.tgz /var/lib/cassandra/data/esmond/raw_data/snapshots/esmond_snapshot
tar -czf esmond-snapshot-stat_aggregations.tgz /var/lib/cassandra/data/esmond/stat_aggregations/snapshots/esmond_snapshot
</pre></div>
</div>
</li>
<li><p class="first">Remotely copy the files to the new server using a tool such as scp:</p>
<div class="highlight-python"><div class="highlight"><pre>scp esmond-snapshot-*.tgz user@newhost:
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="restoring-snapshots">
<h4>Restoring Snapshots<a class="headerlink" href="#restoring-snapshots" title="Permalink to this headline">¶</a></h4>
<p>You may restore you files, either on a new or existing host, with the following steps:</p>
<ol class="arabic">
<li><p class="first">Shutdown cassandra:</p>
<div class="highlight-python"><div class="highlight"><pre>service cassandra stop
</pre></div>
</div>
</li>
<li><p class="first">Clear the commit logs:</p>
<div class="highlight-python"><div class="highlight"><pre>rm -f /var/lib/cassandra/commitlog/*.log
</pre></div>
</div>
</li>
<li><p class="first">Delete all the the old data files:</p>
<div class="highlight-python"><div class="highlight"><pre>rm -f  /var/lib/cassandra/data/esmond/base_rates/*.db
rm -f  /var/lib/cassandra/data/esmond/rate_aggregations/*.db
rm -f  /var/lib/cassandra/data/esmond/raw_data/*.db
rm -f  /var/lib/cassandra/data/esmond/stat_aggregations/*.db
</pre></div>
</div>
</li>
<li><p class="first">Copy the contents of the snapshot into the data directories (<em>NOTE: The location of the snapshot may vary if it was migrated from another host or a label other than esmond_snapshot was used</em>):</p>
<div class="highlight-python"><div class="highlight"><pre>cp /var/lib/cassandra/data/esmond/base_rates/snapshots/esmond_snapshot/* /var/lib/cassandra/data/esmond/base_rates/
cp /var/lib/cassandra/data/esmond/rate_aggregations/snapshots/esmond_snapshot/* /var/lib/cassandra/data/esmond/rate_aggregations/
cp /var/lib/cassandra/data/esmond/raw_data/snapshots/esmond_snapshot/* /var/lib/cassandra/data/esmond/raw_data/
cp /var/lib/cassandra/data/esmond/stat_aggregations/snapshots/esmond_snapshot/* /var/lib/cassandra/data/esmond/stat_aggregations/
</pre></div>
</div>
</li>
<li><p class="first">Start cassandra:</p>
<div class="highlight-python"><div class="highlight"><pre>service cassandra start
</pre></div>
</div>
</li>
<li><p class="first">Run a repair:</p>
<div class="highlight-python"><div class="highlight"><pre>nodetool repair
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="clearing-snapshots">
<h4>Clearing snapshots<a class="headerlink" href="#clearing-snapshots" title="Permalink to this headline">¶</a></h4>
<p>You may want to clear a snapshot because it&#8217;s too old to be useful, you&#8217;d like to delete data to which it is linked or you mistakenly created a snapshot testing the commands in the previous section. Rather than removing all the files by hand you can use a nodetool command to do so. Below is an example of how to remove the snapshot labelled esmond_snapshot in the esmond keyspace:</p>
<div class="highlight-python"><div class="highlight"><pre>nodetool clearsnapshot -t esmond_snapshot -- esmond
</pre></div>
</div>
<p>If you want to clear all snapshots in the esmond keyspace run:</p>
<div class="highlight-python"><div class="highlight"><pre>nodetool clearsnapshot -- esmond
</pre></div>
</div>
</div>
</div>
<div class="section" id="postgresql-snapshots-with-pg-dump-and-pg-restore">
<span id="multi-ma-backups-snapshots-postgresql"></span><h3>PostgreSQL Snapshots with <cite>pg_dump</cite> and <cite>pg_restore</cite><a class="headerlink" href="#postgresql-snapshots-with-pg-dump-and-pg-restore" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>Creating the Snapshot<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>You may create a snapshot of your database with the following command:</p>
<blockquote>
<div><p><em>CentOS/RedHat:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>pg_dump -F t -f esmond.tar -U esmond
</pre></div>
</div>
<p><em>Debian/Ubuntu:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>sudo -u postgres pg_dump -F t -f esmond.tar esmond
</pre></div>
</div>
</div></blockquote>
<p>This will create a tarball file in the current directory named esmond.tar. Note that this is a new file and though compressed, will consume additional disk space.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are prompted for a password, see the <em>sql_db_password</em> property in <em>/etc/esmond/esmond.conf</em></p>
</div>
</div>
<div class="section" id="moving-the-snapshot-to-a-remote-server">
<h4>Moving the Snapshot to a Remote Server<a class="headerlink" href="#moving-the-snapshot-to-a-remote-server" title="Permalink to this headline">¶</a></h4>
<p>Moving the snapshot to a different server is as simple using your favorite remote copy tool to move the tarball to another server. For example, using <em>scp</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>scp esmond.tar user@remote-host:
</pre></div>
</div>
</div>
<div class="section" id="restoring-the-snapshot">
<h4>Restoring the Snapshot<a class="headerlink" href="#restoring-the-snapshot" title="Permalink to this headline">¶</a></h4>
<p>You may restore the snapshot with the following command:</p>
<blockquote>
<div><p><em>CentOS/RedHat:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>pg_restore -c -U esmond -d esmond esmond.tar
</pre></div>
</div>
<p><em>Debian/Ubuntu:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>sudo -u postgres pg_restore -c -d esmond esmond.tar
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are prompted for a password, see the <em>sql_db_password</em> property in <em>/etc/esmond/esmond.conf</em></p>
</div>
<p>This will delete any existing data and replace it with the backup. See the pg_restore documentation for more details.</p>
</div>
</div>
</div>
<div class="section" id="migrating-data">
<h2>Migrating Data<a class="headerlink" href="#migrating-data" title="Permalink to this headline">¶</a></h2>
<p>All hardware is eventually retired and when this happens you may want to move your data to a new server. This section covers how to migrate both the Cassandra and PostgreSQL data.</p>
<div class="section" id="migrating-cassandra-data">
<h3>Migrating Cassandra Data<a class="headerlink" href="#migrating-cassandra-data" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If migrating to a server with a different architecture or operating system it is recommended you instead follow the steps in <a class="reference internal" href="#multi-ma-backups-snapshots-cassandra"><em>Cassandra Snapshots with nodetool</em></a> for creating, migrating and restoring snapshots.</p>
</div>
<p>By default, packaged installs of cassandra keep all data in <em>/var/lib/cassandra</em>. If you are migrating to a server running a similar operating system and architecture as the old system, a valid option may be simply stopping your cassandra server and copying the directory to the new host. For example:</p>
<div class="highlight-python"><div class="highlight"><pre>service cassandra stop
scp -r /var/lib/cassandra user@newhost:cassandra
</pre></div>
</div>
<p>You can then restore the data as follows:</p>
<div class="highlight-python"><div class="highlight"><pre>service cassandra stop
rm -rf /var/lib/cassandra/*
mv cassandra/* /var/lib/cassandra/
chown -R cassandra:cassandra /var/lib/cassandra/*
service cassandra start
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are running on a cluster you may also need to run <em>nodetool repair</em></p>
</div>
</div>
<div class="section" id="migrating-postgresql-data">
<h3>Migrating PostgreSQL Data<a class="headerlink" href="#migrating-postgresql-data" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If migrating to a server with a different architecture or operating system it is recommended you instead follow the steps in <a class="reference internal" href="#multi-ma-backups-snapshots-postgresql"><em>PostgreSQL Snapshots with pg_dump and pg_restore</em></a> for creating, migrating and restoring data.</p>
</div>
<p>By default, packaged installs of PostgreSQL keep all data in <em>/var/lib/pgsql</em>. If you are migrating to a server running a similar operating system and architecture as the old system, a valid option may be simply stopping your PostgreSQL server and copying the directory to the new host. For example:</p>
<blockquote>
<div><p><em>CentOS/RedHat:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>service pgsql stop
scp -r /var/lib/pgsql user@newhost:pgsql
</pre></div>
</div>
<p><em>Debian/Ubuntu:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>service postgresql stop
scp -r /var/lib/postgresql user@newhost:pgsql
</pre></div>
</div>
</div></blockquote>
<p>You can then restore the data as follows:</p>
<blockquote>
<div><p><em>CentOS/RedHat:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>service pgsql stop
rm -rf /var/lib/pgsql/*
mv pgsql/* /var/lib/pgsql/
chown -R postgres:postgres /var/lib/pgsql/*
service pgsql start
</pre></div>
</div>
<p><em>Debian/Ubuntu:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>service postgresql stop
rm -rf /var/lib/postgresql/*
mv pgsql/* /var/lib/postgresql/
chown -R postgres:postgres /var/lib/postgresql/*
service postgresql start
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="deleting-old-data">
<span id="multi-ma-backups-delete"></span><h2>Deleting Old Data<a class="headerlink" href="#deleting-old-data" title="Permalink to this headline">¶</a></h2>
<p>You may want to remove old data over time to conserve disk space or to clear out measurements you no longer want displayed. Currently esmond comes with a tool named <cite>ps_remove_data.py</cite> capable of deleting data based on age in both in Cassandra and PostgreSQL. This section details usage of that tool.</p>
<div class="section" id="using-ps-remove-data-py">
<h3>Using <cite>ps_remove_data.py</cite><a class="headerlink" href="#using-ps-remove-data-py" title="Permalink to this headline">¶</a></h3>
<p><cite>ps_remove_data.py</cite> allows you to specify a configuration file defining a data retention policy and then removes data in Cassandra and PostgreSQL based on that policy. The command is installed by default with esmond and can be found at:</p>
<ul class="simple">
<li>/usr/lib/esmond/util/ps_remove_data.py</li>
</ul>
<p>This script accepts the following arguments:</p>
<ul class="simple">
<li><strong>-c &lt;conf-file&gt;</strong>: Optional parameter to set the location of the config file. Defaults to <em>./ps_remove_data.conf</em>.</li>
</ul>
<p>The config file is in JSON format and defines data retention policies for your data. It allows you to match on three values:</p>
<ul class="simple">
<li><strong>event_type</strong> - The type of data for which this policy applies. A valid list can be found in the esmond <a class="reference internal" href="esmond_api_rest.html#psclient-rest-eventtypes"><em>API documentation</em></a>. You may also pass <tt class="docutils literal"><span class="pre">*</span></tt> to match any value.</li>
<li><strong>summary_type</strong> - The type of summary to which this policy applies. Valid values are <em>base</em> for unsummarized data and any value from the list found in <cite>this discussion &lt;psclient-rest-basevsumm&gt;</cite>. You may also pass <tt class="docutils literal"><span class="pre">*</span></tt> to match any value.</li>
<li><strong>summary_window</strong> - An integer indicating the summary window to match (in seconds). A value of 0 means unsummarized (a.k.a base) data. You may also pass <tt class="docutils literal"><span class="pre">*</span></tt> to match any value.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are curious about the summary types and summary windows being used, look in the <em>measurement_archive</em> blocks of you /etc/perfsonar/regulartesting.conf files on your testing nodes.</p>
</div>
<p>In addition to the matching fields you must also set the following:</p>
<ul class="simple">
<li><strong>expire</strong> - The value (in days) after which point the data should be deleted. A value of &#8220;never&#8221; means to always keep data. A value of &#8220;0&#8221; means to delete all matching data  immediately.</li>
</ul>
<p>The script will choose the policy with the most specific match using a preference
order of event_type, summary_type and then summary_window. For example, assume a piece of data matches two policies defined as follows:</p>
<ol class="arabic simple">
<li>One where it matches the <em>event_type</em> but both the other filters are set to <tt class="docutils literal"><span class="pre">*</span></tt></li>
<li>Another where the event_type is <tt class="docutils literal"><span class="pre">*</span></tt> but it matches both <em>summary_type</em> and <em>summary_window</em>,</li>
</ol>
<p>In this example it will choose the first policy where it matches the specific (i.e. not <tt class="docutils literal"><span class="pre">*</span></tt>) event type based on the preference order of the fields.</p>
<p>A full example of a configuration file can be found below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
<span class="s">&quot;policies&quot;</span><span class="p">:</span> <span class="p">[</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;365&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;86400&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;1825&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;histogram-owdelay&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;histogram-rtt&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;histogram-ttl&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;packet-loss-rate&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;packet-count-sent&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;packet-count-lost&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;packet-duplicates&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;packet-reorders&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">},</span>

<span class="p">{</span>
<span class="s">&quot;event_type&quot;</span><span class="p">:</span>      <span class="s">&quot;time-error-estimates&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_type&quot;</span><span class="p">:</span>    <span class="s">&quot;*&quot;</span><span class="p">,</span>
<span class="s">&quot;summary_window&quot;</span><span class="p">:</span>  <span class="s">&quot;0&quot;</span><span class="p">,</span>
<span class="s">&quot;expire&quot;</span><span class="p">:</span>          <span class="s">&quot;180&quot;</span>
<span class="p">}</span>

<span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The example above  can also be found in <em>/usr/lib/esmond/util/ps_remove_data.conf</em> of the system where esmond is installed</p>
</div>
<p>The example contains several policies. The order of the policies is NOT significant. The first policy is a catch-all that removes anything older than 365 days if it does not match any other policies. This policy has a <tt class="docutils literal"><span class="pre">*</span></tt> for every value and is the least specific of a match possible. That means if any part of the other policies match, they will override the expiration of this policy. The second policy, matches all 24 hour (86400 seconds) summaries and keeps them for 5 years. Notice that it extends the life of these types of data from the default policy. The remaining policies match a specific event type and a summary window of 0 (which means unsummarized data) and expires it after 180 days (roughly 6 months). The event types all match that registered by the OWAMP tool, which writes new data every minute. Given the amount of data, this policy deletes it sooner that it would other (presumably less frequently written) data.</p>
<blockquote>
<div><p><em>CentOS/RedHat:</em>:</p>
<p>You can run the tool as follows (replacing -c with your policy file):</p>
<div class="highlight-python"><div class="highlight"><pre>. bin/activate
python /usr/lib/esmond/util/ps_remove_data.py -c usr/lib/esmond/util/ps_remove_data.conf
</pre></div>
</div>
<p><em>Debian/Ubuntu:</em>:</p>
<div class="highlight-python"><div class="highlight"><pre>. /etc/default/esmond
export ESMOND_ROOT ESMOND_CONF
export DJANGO_SETTINGS_MODULE=esmond.settings
python /usr/share/esmond/util/ps_remove_data.py -c /usr/share/esmond/util/ps_remove_data.conf
</pre></div>
</div>
</div></blockquote>
<p>You may consider adding the commands above to a shell script called by cron to regularly clean out the old data.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If running your measurement archive on a perfSONAR Toolkit then a cronjob with a default policy will be setup and run nightly automatically. If you are running a standalone MA, you need to do this yourself.</p>
</div>
<p>Finally, though this tool can be useful it has several limitations that are important to be aware of:</p>
<ul class="simple">
<li>You can only delete data based on it&#8217;s age, NOT other parameters like source or destination</li>
<li>This tool may perform slowly for large deployments with lots of data and/or clustered databases.</li>
</ul>
<p>These limitations will be addressed in future versions of the software.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <nav id="channelNav" class="channelNav">
                
                <ul>
<li><a class="reference internal" href="#">Managing Measurement Archive Data</a><ul>
<li><a class="reference internal" href="#backing-up-and-restoring-data">Backing-up and Restoring Data</a><ul>
<li><a class="reference internal" href="#cassandra-snapshots-with-nodetool">Cassandra Snapshots with <cite>nodetool</cite></a><ul>
<li><a class="reference internal" href="#preparing-your-environment">Preparing Your Environment</a></li>
<li><a class="reference internal" href="#creating-the-snapshot">Creating the Snapshot</a></li>
<li><a class="reference internal" href="#moving-snapshots-to-a-remote-server">Moving Snapshots to a Remote Server</a></li>
<li><a class="reference internal" href="#restoring-snapshots">Restoring Snapshots</a></li>
<li><a class="reference internal" href="#clearing-snapshots">Clearing snapshots</a></li>
</ul>
</li>
<li><a class="reference internal" href="#postgresql-snapshots-with-pg-dump-and-pg-restore">PostgreSQL Snapshots with <cite>pg_dump</cite> and <cite>pg_restore</cite></a><ul>
<li><a class="reference internal" href="#id1">Creating the Snapshot</a></li>
<li><a class="reference internal" href="#moving-the-snapshot-to-a-remote-server">Moving the Snapshot to a Remote Server</a></li>
<li><a class="reference internal" href="#restoring-the-snapshot">Restoring the Snapshot</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#migrating-data">Migrating Data</a><ul>
<li><a class="reference internal" href="#migrating-cassandra-data">Migrating Cassandra Data</a></li>
<li><a class="reference internal" href="#migrating-postgresql-data">Migrating PostgreSQL Data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deleting-old-data">Deleting Old Data</a><ul>
<li><a class="reference internal" href="#using-ps-remove-data-py">Using <cite>ps_remove_data.py</cite></a></li>
</ul>
</li>
</ul>
</li>
</ul>

                <ul>
                  <li>
                  <a href="multi_ma_clustering.html">Previous topic</a>
                  <ul><li><a href="multi_ma_clustering.html" title="previous chapter">Clustering a Measurement Archive</a></li></ul>
                  </li>
                </ul>
                  <ul>
                      <li>
                      <a href="esmond_api_rest.html">Next topic</a>
                      <ul><li><a href="esmond_api_rest.html" title="next chapter">esmond API Reference</a></li></ul>
                      </li>
                  </ul>
                
                
            </nav>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="esmond_api_rest.html" title="esmond API Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="multi_ma_clustering.html" title="Clustering a Measurement Archive"
             >previous</a> |</li>
        <li><a href="index.html">perfSONAR Toolkit 4.2.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <footer id="fat">
        <div class="footerContents">
            <nav id="fatFooterNav" class="fatFooterNav">
                <ul id="menu-partners" class="menu depth-0">
                    <li id="footer-partner-text" class="partner-menu">
                        perfSONAR 
                        <br>
                        partners 
                        <br>
                        include: 
                    </li>
    
                <li id="footer-partner-esnet" class="partner-menu">
                    <a href="http://www.es.net/" title="Visit DOE's Energy Sciences Network"><img src="_static/ESnet-ps.png" alt="" style="border:none;"></a> </li>
                
                <li id="footer-partner-geant" class="partner-menu">
                    <a href="http://www.geant.org/" title="Visit GEANT"><img src="_static/geant-ps.png" alt="" style="border:none;"/></a> </li>
        
                <li id="footer-partner-iu" class="partner-menu">
                    <a href="http://www.iu.edu/" title="Visit Indiana University"><img src="_static/IU-ps.png" alt="" style="border:none;"></a> </li>

                <li id="footer-partner-i2" class="partner-menu">
                    <a href="http://www.internet2.edu/" title="Visit Internet2"><img src="_static/I2-ps.png" alt="" style="border:none;"></a> </li>
                
                <li id="footer-partner-um" class="partner-menu">
                    <a href="http://www.umich.edu/" title="Visit University of Michigan"><img src="_static/UM-ps.png" alt="" style="border:none;"></a> </li>

                </ul>

            </nav>
            <nav id="minFooterNav" class="minFooterNav">
                <span class="copyright">PERFormance Service Oriented Network monitoring ARchitecture </span>
            </nav>
          
        </div> <!-- /footerContents -->
    </footer>
    
    <div class="footer">
        &copy; Copyright 2019, perfSONAR Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>